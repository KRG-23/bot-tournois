services:
  bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    env_file: .env
    environment:
      DATABASE_URL: postgresql://bot:botpass@postgres:5432/botdb?schema=public
      NODE_TLS_REJECT_UNAUTHORIZED: "0"  # dev only: bypass corporate MITM for Discord TLS
    depends_on:
      - postgres
      - redis
    networks:
      - backend
    command: ["npm", "--workspace", "apps/bot", "run", "dev"]
    volumes:
      - ./:/workspace
      - /workspace/node_modules
      - /workspace/apps/bot/node_modules
      - /workspace/packages/core/node_modules
    working_dir: /workspace

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    env_file: .env
    environment:
      DATABASE_URL: postgresql://bot:botpass@postgres:5432/botdb?schema=public
      API_HOST: 0.0.0.0
      NODE_TLS_REJECT_UNAUTHORIZED: "0"  # dev only: bypass corporate MITM for Prisma engine download
    depends_on:
      - postgres
      - redis
    networks:
      - backend
    command: ["npm", "--workspace", "apps/api", "run", "dev"]
    volumes:
      - ./:/workspace
      - /workspace/node_modules
      - /workspace/apps/api/node_modules
      - /workspace/packages/core/node_modules
    working_dir: /workspace
    ports:
      - "3000:3000"

  ui:
    build:
      context: .
      dockerfile: Dockerfile.ui
    env_file: .env
    environment:
      VITE_API_BASE: http://api:3000
    networks:
      - backend
    depends_on:
      - api
    command: ["npm", "--workspace", "apps/ui", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
    volumes:
      - ./:/workspace
      - /workspace/node_modules
      - /workspace/apps/ui/node_modules
      - /workspace/packages/core/node_modules
    working_dir: /workspace
    ports:
      - "5173:5173"

  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: bot
      POSTGRES_PASSWORD: botpass
      POSTGRES_DB: botdb
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - backend
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - backend
    ports:
      - "6379:6379"

volumes:
  pgdata:

networks:
  backend:
    driver: bridge
